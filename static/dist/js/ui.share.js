"use strict";require("./ui.modal");var $=require("jquery"),UI=require("./core"),QRCode=require("./util.qrcode"),doc=document,$doc=$(doc),Share=function(e){this.options=$.extend({},Share.DEFAULTS,e||{}),this.$element=null,this.$wechatQr=null,this.pics=null,this.inited=!1,this.active=!1};Share.DEFAULTS={sns:["weibo","qq","qzone","tqq","wechat","renren"],title:"分享到",cancel:"取消",closeOnShare:!0,id:UI.utils.generateGUID("am-share"),desc:"Hi，孤夜观天象，发现一个不错的西西，分享一下下 ;-)",via:"Amaze UI",tpl:'<div class="am-share am-modal-actions" id="<%= id %>"><h3 class="am-share-title"><%= title %></h3><ul class="am-share-sns am-avg-sm-3"><% for(var i = 0; i < sns.length; i++) {%><li><a href="<%= sns[i].shareUrl %>" data-am-share-to="<%= sns[i].id %>" ><i class="am-icon-<%= sns[i].icon %>"></i><span><%= sns[i].title %></span></a></li><% } %></ul><div class="am-share-footer"><button class="am-btn am-btn-default am-btn-block" data-am-share-close><%= cancel %></button></div></div>'},Share.SNS={weibo:{title:"新浪微博",url:"http://service.weibo.com/share/share.php",width:620,height:450,icon:"weibo"},qq:{title:"QQ 好友",url:"http://connect.qq.com/widget/shareqq/index.html",icon:"qq"},qzone:{title:"QQ 空间",url:"http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey",icon:"star"},tqq:{title:"腾讯微博",url:"http://v.t.qq.com/share/share.php",icon:"tencent-weibo"},wechat:{title:"微信",url:"[qrcode]",icon:"wechat"},renren:{title:"人人网",url:"http://widget.renren.com/dialog/share",icon:"renren"},douban:{title:"豆瓣",url:"http://www.douban.com/recommend/",icon:"share-alt"},mail:{title:"邮件分享",url:"mailto:",icon:"envelope-o"},sms:{title:"短信分享",url:"sms:",icon:"comment"}},Share.prototype.render=function(){var e=this.options,t=[],i=encodeURIComponent(doc.title),a=encodeURIComponent(doc.location),s="?body="+i+a;return e.sns.forEach(function(o,r){if(Share.SNS[o]){var n,c=Share.SNS[o];c.id=o,n="mail"===o?s+"&subject="+e.desc:"sms"===o?s:"?url="+a+"&title="+i,c.shareUrl=c.url+n,t.push(c)}}),UI.template(e.tpl,$.extend({},e,{sns:t}))},Share.prototype.init=function(){if(!this.inited){var e=this,t="[data-am-share-to]";$doc.ready($.proxy(function(){$("body").append(this.render()),this.$element=$("#"+this.options.id),this.$element.find("[data-am-share-close]").on("click.share.amui",function(){e.close()})},this)),$doc.on("click.share.amui",t,$.proxy(function(e){var i=$(e.target),a=i.is(t)&&i||i.parent(t),s=a.attr("data-am-share-to");"mail"!==s&&"sms"!==s&&(e.preventDefault(),this.shareTo(s,this.setData(s))),this.close()},this)),this.inited=!0}},Share.prototype.open=function(){!this.inited&&this.init(),this.$element&&this.$element.modal("open"),this.$element.trigger("open.share.amui"),this.active=!0},Share.prototype.close=function(){this.$element&&this.$element.modal("close"),this.$element.trigger("close.share.amui"),this.active=!1},Share.prototype.toggle=function(){this.active?this.close():this.open()},Share.prototype.setData=function(e){if(e){var t={url:doc.location,title:doc.title},i=this.options.desc,a=this.pics||[],s=/^(qzone|qq|tqq)$/;if(s.test(e)&&!a.length){for(var o=doc.images,r=0;r<o.length&&r<10;r++)!!o[r].src&&a.push(encodeURIComponent(o[r].src));this.pics=a}switch(e){case"qzone":t.desc=i,t.site=this.options.via,t.pics=a.join("|");break;case"qq":t.desc=i,t.site=this.options.via,t.pics=a[0];break;case"tqq":t.pic=a.join("|")}return t}},Share.prototype.shareTo=function(e,t){var i=Share.SNS[e];if(i){if("wechat"===e||"weixin"===e)return this.wechatQr();var a=[];for(var s in t)t[s]&&a.push(s.toString()+"="+("pic"===s||"pics"===s?t[s]:encodeURIComponent(t[s])));window.open(i.url+"?"+a.join("&"))}},Share.prototype.wechatQr=function(){if(!this.$wechatQr){var e=UI.utils.generateGUID("am-share-wechat"),t=$('<div class="am-modal am-modal-no-btn am-share-wechat-qr"><div class="am-modal-dialog"><div class="am-modal-hd">分享到微信 <a href="" class="am-close am-close-spin" data-am-modal-close>&times;</a> </div><div class="am-modal-bd"><div class="am-share-wx-qr"></div><div class="am-share-wechat-tip">打开微信，点击底部的<em>发现</em>，<br/> 使用<em>扫一扫</em>将网页分享至朋友圈</div></div></div></div>');t.attr("id",e);var i=new QRCode({render:"canvas",correctLevel:0,text:doc.location.href,width:180,height:180,background:"#fff",foreground:"#000"});t.find(".am-share-wx-qr").html(i),t.appendTo($("body")),this.$wechatQr=$("#"+e)}this.$wechatQr.modal("open")};var share=new Share;$doc.on("click.share.amui.data-api",'[data-am-toggle="share"]',function(e){e.preventDefault(),share.toggle()}),module.exports=UI.share=share;