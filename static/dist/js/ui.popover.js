"use strict";var $=require("jquery"),UI=require("./core"),$w=$(window),Popover=function(o,e){this.options=$.extend({},Popover.DEFAULTS,e),this.$element=$(o),this.active=null,this.$popover=this.options.target&&$(this.options.target)||null,this.init(),this._bindEvents()};Popover.DEFAULTS={theme:null,trigger:"click",content:"",open:!1,target:null,tpl:'<div class="am-popover"><div class="am-popover-inner"></div><div class="am-popover-caret"></div></div>'},Popover.prototype.init=function(){function o(){t.sizePopover()}var e,t=this,p=this.$element;this.options.target||(this.$popover=this.getPopover(),this.setContent()),e=this.$popover,e.appendTo($("body")),this.sizePopover(),p.on("open.popover.amui",function(){$(window).on("resize.popover.amui",UI.utils.debounce(o,50))}),p.on("close.popover.amui",function(){$(window).off("resize.popover.amui",o)}),this.options.open&&this.open()},Popover.prototype.sizePopover=function(){var o=this.$element,e=this.$popover;if(e&&e.length){var t=e.outerWidth(),p=e.outerHeight(),i=e.find(".am-popover-caret"),r=i.outerWidth()/2||8,s=p+8,n=o.outerWidth(),v=o.outerHeight(),a=o.offset(),h=o[0].getBoundingClientRect(),l=$w.height(),m=$w.width(),u=0,c=0,d=0,f=2,$="top";e.css({left:"",top:""}).removeClass("am-popover-left am-popover-right am-popover-top am-popover-bottom"),s-f<h.top+f?u=a.top-s-f:s<l-h.top-h.height?($="bottom",u=a.top+v+r+f):($="middle",u=v/2+a.top-p/2),"top"===$||"bottom"===$?(c=n/2+a.left-t/2,d=c,c<5&&(c=5),c+t>m&&(c=m-t-20),"top"===$&&e.addClass("am-popover-top"),"bottom"===$&&e.addClass("am-popover-bottom"),d-=c):"middle"===$&&(c=a.left-t-r,e.addClass("am-popover-left"),c<5&&(c=a.left+n+r,e.removeClass("am-popover-left").addClass("am-popover-right")),c+t>m&&(c=m-t-5,e.removeClass("am-popover-left").addClass("am-popover-right"))),e.css({top:u+"px",left:c+"px"})}},Popover.prototype.toggle=function(){return this[this.active?"close":"open"]()},Popover.prototype.open=function(){var o=this.$popover;this.$element.trigger("open.popover.amui"),this.sizePopover(),o.show().addClass("am-active"),this.active=!0},Popover.prototype.close=function(){var o=this.$popover;this.$element.trigger("close.popover.amui"),o.removeClass("am-active").trigger("closed.popover.amui").hide(),this.active=!1},Popover.prototype.getPopover=function(){var o=UI.utils.generateGUID("am-popover"),e=[];return this.options.theme&&$.each(this.options.theme.split(" "),function(o,t){e.push("am-popover-"+$.trim(t))}),$(this.options.tpl).attr("id",o).addClass(e.join(" "))},Popover.prototype.setContent=function(o){o=o||this.options.content,this.$popover&&this.$popover.find(".am-popover-inner").empty().html(o)},Popover.prototype._bindEvents=function(){for(var o="popover.amui",e=this.options.trigger.split(" "),t=e.length;t--;){var p=e[t];if("click"===p)this.$element.on("click."+o,$.proxy(this.toggle,this));else{var i="hover"==p?"mouseenter":"focusin",r="hover"==p?"mouseleave":"focusout";this.$element.on(i+"."+o,$.proxy(this.open,this)),this.$element.on(r+"."+o,$.proxy(this.close,this))}}},Popover.prototype.destroy=function(){this.$element.off(".popover.amui").removeData("amui.popover"),this.$popover.remove()},UI.plugin("popover",Popover),UI.ready(function(o){$("[data-am-popover]",o).popover()}),module.exports=Popover;