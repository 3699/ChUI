"use strict";function Plugin(i,t){return this.each(function(){var a=$(this),o=a.data("amui.modal"),e="object"==typeof i&&i;o||a.data("amui.modal",o=new Modal(this,e)),"string"==typeof i?o[i]&&o[i](t):o.toggle(i&&i.relatedTarget||void 0)})}var $=require("jquery"),UI=require("./core"),dimmer=require("./ui.dimmer"),$doc=$(document),supportTransition=UI.support.transition,Modal=function(i,t){this.options=$.extend({},Modal.DEFAULTS,t||{}),this.$element=$(i),this.$dialog=this.$element.find(".am-modal-dialog"),this.$element.attr("id")||this.$element.attr("id",UI.utils.generateGUID("am-modal")),this.isPopup=this.$element.hasClass("am-popup"),this.isActions=this.$element.hasClass("am-modal-actions"),this.isPrompt=this.$element.hasClass("am-modal-prompt"),this.isLoading=this.$element.hasClass("am-modal-loading"),this.active=this.transitioning=this.relatedTarget=null,this.dimmer=this.options.dimmer?dimmer:{open:function(){},close:function(){}},this.events()};Modal.DEFAULTS={className:{active:"am-modal-active",out:"am-modal-out"},selector:{modal:".am-modal",active:".am-modal-active"},closeViaDimmer:!0,cancelable:!0,onConfirm:function(){},onCancel:function(){},closeOnCancel:!0,closeOnConfirm:!0,dimmer:!0,height:void 0,width:void 0,duration:300,transitionEnd:supportTransition&&supportTransition.end+".modal.amui"},Modal.prototype.toggle=function(i){return this.active?this.close():this.open(i)},Modal.prototype.open=function(i){var t=this.$element,a=this.options,o=this.isPopup,e=a.width,n=a.height,s={};if(!this.active&&this.$element.length){i&&(this.relatedTarget=i),this.transitioning&&(clearTimeout(t.transitionEndTimmer),t.transitionEndTimmer=null,t.trigger(a.transitionEnd).off(a.transitionEnd)),o&&this.$element.show(),this.active=!0,t.trigger($.Event("open.modal.amui",{relatedTarget:i})),this.dimmer.open(t),t.show().redraw(),o||this.isActions||(e&&(s.width=parseInt(e,10)+"px"),n&&(s.height=parseInt(n,10)+"px"),this.$dialog.css(s)),t.removeClass(a.className.out).addClass(a.className.active),this.transitioning=1;var l=function(){t.trigger($.Event("opened.modal.amui",{relatedTarget:i})),this.transitioning=0,this.isPrompt&&this.$dialog.find("input").eq(0).focus()};return supportTransition?void t.one(a.transitionEnd,$.proxy(l,this)).emulateTransitionEnd(a.duration):l.call(this)}},Modal.prototype.close=function(i){if(this.active){var t=this.$element,a=this.options,o=this.isPopup;this.transitioning&&(clearTimeout(t.transitionEndTimmer),t.transitionEndTimmer=null,t.trigger(a.transitionEnd).off(a.transitionEnd),this.dimmer.close(t,!0)),this.$element.trigger($.Event("close.modal.amui",{relatedTarget:i})),this.transitioning=1;var e=function(){t.trigger("closed.modal.amui"),o&&t.removeClass(a.className.out),t.hide(),this.transitioning=0,this.dimmer.close(t,!1),this.active=!1};return t.removeClass(a.className.active).addClass(a.className.out),supportTransition?void t.one(a.transitionEnd,$.proxy(e,this)).emulateTransitionEnd(a.duration):e.call(this)}},Modal.prototype.events=function(){var i=this,t=this.options,a=this.$element,o=this.dimmer.$element,e=a.find(".am-modal-prompt-input"),n=a.find("[data-am-modal-confirm]"),s=a.find("[data-am-modal-cancel]"),l=function(){var i=[];return e.each(function(){i.push($(this).val())}),0===i.length?void 0:1===i.length?i[0]:i};this.options.cancelable&&a.on("keyup.modal.amui",function(t){i.active&&27===t.which&&(a.trigger("cancel.modal.amui"),i.close())}),this.options.dimmer&&this.options.closeViaDimmer&&!this.isLoading&&o.on("click.dimmer.modal.amui",function(){i.close()}),a.on("click.close.modal.amui","[data-am-modal-close], .am-modal-btn",function(a){a.preventDefault();var o=$(this);o.is(n)?t.closeOnConfirm&&i.close():o.is(s)?t.closeOnCancel&&i.close():i.close()}).on("click",function(i){$(i.target).is(a)&&o.trigger("click.dimmer.modal.amui")}),n.on("click.confirm.modal.amui",function(){a.trigger($.Event("confirm.modal.amui",{trigger:this}))}),s.on("click.cancel.modal.amui",function(){a.trigger($.Event("cancel.modal.amui",{trigger:this}))}),a.on("confirm.modal.amui",function(t){t.data=l(),i.options.onConfirm.call(i,t)}).on("cancel.modal.amui",function(t){t.data=l(),i.options.onCancel.call(i,t)})},$.fn.modal=Plugin,$doc.on("click.modal.amui.data-api","[data-am-modal]",function(){var i=$(this),t=UI.utils.parseOptions(i.attr("data-am-modal")),a=$(t.target||this.href&&this.href.replace(/.*(?=#[^\s]+$)/,"")),o=a.data("amui.modal")?"toggle":t;Plugin.call(a,o,this)}),module.exports=UI.modal=Modal;