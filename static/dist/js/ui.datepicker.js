"use strict";var $=require("jquery"),UI=require("./core"),$doc=$(document),Datepicker=function(e,t){if(this.$element=$(e),this.options=$.extend({},Datepicker.DEFAULTS,t),this.format=DPGlobal.parseFormat(this.options.format),this.$element.data("date",this.options.date),this.language=this.getLocale(this.options.locale),this.theme=this.options.theme,this.$picker=$(DPGlobal.template).appendTo("body").on({click:$.proxy(this.click,this)}),this.isInput=this.$element.is("input"),this.component=!!this.$element.is(".am-datepicker-date")&&this.$element.find(".am-datepicker-add-on"),this.isInput?this.$element.on({"click.datepicker.amui":$.proxy(this.open,this),"keyup.datepicker.amui":$.proxy(this.update,this)}):this.component?this.component.on("click.datepicker.amui",$.proxy(this.open,this)):this.$element.on("click.datepicker.amui",$.proxy(this.open,this)),this.minViewMode=this.options.minViewMode,"string"==typeof this.minViewMode)switch(this.minViewMode){case"months":this.minViewMode=1;break;case"years":this.minViewMode=2;break;default:this.minViewMode=0}if(this.viewMode=this.options.viewMode,"string"==typeof this.viewMode)switch(this.viewMode){case"months":this.viewMode=1;break;case"years":this.viewMode=2;break;default:this.viewMode=0}this.startViewMode=this.viewMode,this.weekStart=(this.options.weekStart||Datepicker.locales[this.language].weekStart||0)%7,this.weekEnd=(this.weekStart+6)%7,this.onRender=this.options.onRender,this.setTheme(),this.fillDow(),this.fillMonths(),this.update(),this.showMode()};Datepicker.DEFAULTS={locale:"zh_CN",format:"yyyy-mm-dd",weekStart:void 0,viewMode:0,minViewMode:0,date:"",theme:"",autoClose:1,onRender:function(e){return""}},Datepicker.prototype.open=function(e){this.$picker.show(),this.height=this.component?this.component.outerHeight():this.$element.outerHeight(),this.place(),$(window).on("resize.datepicker.amui",$.proxy(this.place,this)),e&&(e.stopPropagation(),e.preventDefault());var t=this;$doc.on("mousedown.datapicker.amui touchstart.datepicker.amui",function(e){0===$(e.target).closest(".am-datepicker").length&&t.close()}),this.$element.trigger({type:"open.datepicker.amui",date:this.date})},Datepicker.prototype.close=function(){this.$picker.hide(),$(window).off("resize.datepicker.amui",this.place),this.viewMode=this.startViewMode,this.showMode(),this.isInput||$(document).off("mousedown.datapicker.amui touchstart.datepicker.amui",this.close),this.$element.trigger({type:"close.datepicker.amui",date:this.date})},Datepicker.prototype.set=function(){var e,t=DPGlobal.formatDate(this.date,this.format);this.isInput?e=this.$element.attr("value",t):(this.component&&(e=this.$element.find("input").attr("value",t)),this.$element.data("date",t)),e&&e.trigger("change")},Datepicker.prototype.setValue=function(e){"string"==typeof e?this.date=DPGlobal.parseDate(e,this.format):this.date=new Date(e),this.set(),this.viewDate=new Date(this.date.getFullYear(),this.date.getMonth(),1,0,0,0,0),this.fill()},Datepicker.prototype.place=function(){var e=this.component?this.component.offset():this.$element.offset(),t=this.component?this.component.width():this.$element.width(),a=e.top+this.height,i=e.left,s=$doc.width()-e.left-t,o=this.isOutView();if(this.$picker.removeClass("am-datepicker-right"),this.$picker.removeClass("am-datepicker-up"),$doc.width()>640){if(o.outRight)return this.$picker.addClass("am-datepicker-right"),void this.$picker.css({top:a,left:"auto",right:s});o.outBottom&&(this.$picker.addClass("am-datepicker-up"),a=e.top-this.$picker.outerHeight(!0))}else i=0;this.$picker.css({top:a,left:i})},Datepicker.prototype.update=function(e){this.date=DPGlobal.parseDate("string"==typeof e?e:this.isInput?this.$element.prop("value"):this.$element.data("date"),this.format),this.viewDate=new Date(this.date.getFullYear(),this.date.getMonth(),1,0,0,0,0),this.fill()},Datepicker.prototype.fillDow=function(){for(var e=this.weekStart,t="<tr>";e<this.weekStart+7;)t+='<th class="am-datepicker-dow">'+Datepicker.locales[this.language].daysMin[e++%7]+"</th>";t+="</tr>",this.$picker.find(".am-datepicker-days thead").append(t)},Datepicker.prototype.fillMonths=function(){for(var e="",t=0;t<12;)e+='<span class="am-datepicker-month">'+Datepicker.locales[this.language].monthsShort[t++]+"</span>";this.$picker.find(".am-datepicker-months td").append(e)},Datepicker.prototype.fill=function(){var e=new Date(this.viewDate),t=e.getFullYear(),a=e.getMonth(),i=this.date.valueOf(),s=new Date(t,a-1,28,0,0,0,0),o=DPGlobal.getDaysInMonth(s.getFullYear(),s.getMonth()),r=this.$picker.find(".am-datepicker-days .am-datepicker-select");"zh_CN"===this.language?r.text(t+Datepicker.locales[this.language].year[0]+" "+Datepicker.locales[this.language].months[a]):r.text(Datepicker.locales[this.language].months[a]+" "+t),s.setDate(o),s.setDate(o-(s.getDay()-this.weekStart+7)%7);var n=new Date(s);n.setDate(n.getDate()+42),n=n.valueOf();for(var h,d,p,c=[];s.valueOf()<n;)s.getDay()===this.weekStart&&c.push("<tr>"),h=this.onRender(s,0),d=s.getFullYear(),p=s.getMonth(),p<a&&d===t||d<t?h+=" am-datepicker-old":(p>a&&d===t||d>t)&&(h+=" am-datepicker-new"),s.valueOf()===i&&(h+=" am-active"),c.push('<td class="am-datepicker-day '+h+'">'+s.getDate()+"</td>"),s.getDay()===this.weekEnd&&c.push("</tr>"),s.setDate(s.getDate()+1);this.$picker.find(".am-datepicker-days tbody").empty().append(c.join(""));var l=this.date.getFullYear(),m=this.$picker.find(".am-datepicker-months").find(".am-datepicker-select").text(t);m=m.end().find("span").removeClass("am-active").removeClass("am-disabled");for(var u=0;u<12;)this.onRender(e.setFullYear(t,u),1)&&m.eq(u).addClass("am-disabled"),u++;l===t&&m.eq(this.date.getMonth()).removeClass("am-disabled").addClass("am-active"),c="",t=10*parseInt(t/10,10);var k,v=this.$picker.find(".am-datepicker-years").find(".am-datepicker-select").text(t+"-"+(t+9)).end().find("td"),w=new Date(this.viewDate);t-=1;for(var f=-1;f<11;f++)k=this.onRender(w.setFullYear(t),2),c+='<span class="'+k+(f===-1||10===f?" am-datepicker-old":"")+(l===t?" am-active":"")+'">'+t+"</span>",t+=1;v.html(c)},Datepicker.prototype.click=function(e){e.stopPropagation(),e.preventDefault();var t,a,i=this.$picker.find(".am-datepicker-days").find(".am-active"),s=this.$picker.find(".am-datepicker-months"),o=s.find(".am-active").index(),r=$(e.target).closest("span, td, th");if(1===r.length)switch(r[0].nodeName.toLowerCase()){case"th":switch(r[0].className){case"am-datepicker-switch":this.showMode(1);break;case"am-datepicker-prev":case"am-datepicker-next":this.viewDate["set"+DPGlobal.modes[this.viewMode].navFnc].call(this.viewDate,this.viewDate["get"+DPGlobal.modes[this.viewMode].navFnc].call(this.viewDate)+DPGlobal.modes[this.viewMode].navStep*("am-datepicker-prev"===r[0].className?-1:1)),this.fill(),this.set()}break;case"span":if(r.is(".am-disabled"))return;r.is(".am-datepicker-month")?(t=r.parent().find("span").index(r),r.is(".am-active")?this.viewDate.setMonth(t,i.text()):this.viewDate.setMonth(t)):(a=parseInt(r.text(),10)||0,r.is(".am-active")?this.viewDate.setFullYear(a,o,i.text()):this.viewDate.setFullYear(a)),0!==this.viewMode&&(this.date=new Date(this.viewDate),this.$element.trigger({type:"changeDate.datepicker.amui",date:this.date,viewMode:DPGlobal.modes[this.viewMode].clsName})),this.showMode(-1),this.fill(),this.set();break;case"td":if(r.is(".am-datepicker-day")&&!r.is(".am-disabled")){var n=parseInt(r.text(),10)||1;t=this.viewDate.getMonth(),r.is(".am-datepicker-old")?t-=1:r.is(".am-datepicker-new")&&(t+=1),a=this.viewDate.getFullYear(),this.date=new Date(a,t,n,0,0,0,0),this.viewDate=new Date(a,t,Math.min(28,n),0,0,0,0),this.fill(),this.set(),this.$element.trigger({type:"changeDate.datepicker.amui",date:this.date,viewMode:DPGlobal.modes[this.viewMode].clsName}),this.options.autoClose&&this.close()}}},Datepicker.prototype.mousedown=function(e){e.stopPropagation(),e.preventDefault()},Datepicker.prototype.showMode=function(e){e&&(this.viewMode=Math.max(this.minViewMode,Math.min(2,this.viewMode+e))),this.$picker.find(">div").hide().filter(".am-datepicker-"+DPGlobal.modes[this.viewMode].clsName).show()},Datepicker.prototype.isOutView=function(){var e=this.component?this.component.offset():this.$element.offset(),t={outRight:!1,outBottom:!1},a=this.$picker,i=e.left+a.outerWidth(!0),s=e.top+a.outerHeight(!0)+this.$element.innerHeight();return i>$doc.width()&&(t.outRight=!0),s>$doc.height()&&(t.outBottom=!0),t},Datepicker.prototype.getLocale=function(e){return e||(e=navigator.language&&navigator.language.split("-"),e[1]=e[1].toUpperCase(),e=e.join("_")),Datepicker.locales[e]||(e="en_US"),e},Datepicker.prototype.setTheme=function(){this.theme&&this.$picker.addClass("am-datepicker-"+this.theme)},Datepicker.locales={en_US:{days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],daysShort:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],daysMin:["Su","Mo","Tu","We","Th","Fr","Sa"],months:["January","February","March","April","May","June","July","August","September","October","November","December"],monthsShort:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],weekStart:0},zh_CN:{days:["星期日","星期一","星期二","星期三","星期四","星期五","星期六"],daysShort:["周日","周一","周二","周三","周四","周五","周六"],daysMin:["日","一","二","三","四","五","六"],months:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],monthsShort:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],weekStart:1,year:["年"]}};var DPGlobal={modes:[{clsName:"days",navFnc:"Month",navStep:1},{clsName:"months",navFnc:"FullYear",navStep:1},{clsName:"years",navFnc:"FullYear",navStep:10}],isLeapYear:function(e){return e%4===0&&e%100!==0||e%400===0},getDaysInMonth:function(e,t){return[31,DPGlobal.isLeapYear(e)?29:28,31,30,31,30,31,31,30,31,30,31][t]},parseFormat:function(e){var t=e.match(/[.\/\-\s].*?/),a=e.split(/\W+/);if(!t||!a||0===a.length)throw new Error("Invalid date format.");return{separator:t,parts:a}},parseDate:function(e,t){var a,i=e.split(t.separator);if(e=new Date,e.setHours(0),e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0),i.length===t.parts.length){for(var s=e.getFullYear(),o=e.getDate(),r=e.getMonth(),n=0,h=t.parts.length;n<h;n++)switch(a=parseInt(i[n],10)||1,t.parts[n]){case"dd":case"d":o=a,e.setDate(a);break;case"mm":case"m":r=a-1,e.setMonth(a-1);break;case"yy":s=2e3+a,e.setFullYear(2e3+a);break;case"yyyy":s=a,e.setFullYear(a)}e=new Date(s,r,o,0,0,0)}return e},formatDate:function(e,t){var a={d:e.getDate(),m:e.getMonth()+1,yy:e.getFullYear().toString().substring(2),yyyy:e.getFullYear()},i=[];a.dd=(a.d<10?"0":"")+a.d,a.mm=(a.m<10?"0":"")+a.m;for(var s=0,o=t.parts.length;s<o;s++)i.push(a[t.parts[s]]);return i.join(t.separator)},headTemplate:'<thead><tr class="am-datepicker-header"><th class="am-datepicker-prev"><i class="am-datepicker-prev-icon"></i></th><th colspan="5" class="am-datepicker-switch"><div class="am-datepicker-select"></div></th><th class="am-datepicker-next"><i class="am-datepicker-next-icon"></i></th></tr></thead>',contTemplate:'<tbody><tr><td colspan="7"></td></tr></tbody>'};DPGlobal.template='<div class="am-datepicker am-datepicker-dropdown"><div class="am-datepicker-caret"></div><div class="am-datepicker-days"><table class="am-datepicker-table">'+DPGlobal.headTemplate+'<tbody></tbody></table></div><div class="am-datepicker-months"><table class="am-datepicker-table">'+DPGlobal.headTemplate+DPGlobal.contTemplate+'</table></div><div class="am-datepicker-years"><table class="am-datepicker-table">'+DPGlobal.headTemplate+DPGlobal.contTemplate+"</table></div></div>",UI.plugin("datepicker",Datepicker),UI.ready(function(e){$("[data-am-datepicker]").datepicker()}),module.exports=UI.datepicker=Datepicker;