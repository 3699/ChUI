"use strict";var $=require("jquery"),UI=require("./core");$.expr[":"].containsNC=function(e,t,s,i){return(e.textContent||e.innerText||"").toLowerCase().indexOf((s[3]||"").toLowerCase())>=0};var Selected=function(e,t){this.$element=$(e),this.options=$.extend({},Selected.DEFAULTS,{placeholder:e.getAttribute("placeholder")||Selected.DEFAULTS.placeholder},t),this.$originalOptions=this.$element.find("option"),this.multiple=e.multiple,this.$selector=null,this.initialized=!1,this.init()};Selected.DEFAULTS={btnWidth:null,btnSize:null,btnStyle:"default",dropUp:0,maxHeight:null,maxChecked:null,placeholder:"点击选择...",selectedClass:"am-checked",disabledClass:"am-disabled",searchBox:!1,tpl:'<div class="am-selected am-dropdown <%= dropUp ? \'am-dropdown-up\': \'\' %>" id="<%= id %>" data-am-dropdown>  <button type="button" class="am-selected-btn am-btn am-dropdown-toggle">    <span class="am-selected-status am-fl"></span>    <i class="am-selected-icon am-icon-caret-<%= dropUp ? \'up\' : \'down\' %>"></i>  </button>  <div class="am-selected-content am-dropdown-content">    <h2 class="am-selected-header"><span class="am-icon-chevron-left">返回</span></h2>   <% if (searchBox) { %>   <div class="am-selected-search">     <input autocomplete="off" class="am-form-field am-input-sm" />   </div>   <% } %>    <ul class="am-selected-list">      <% for (var i = 0; i < options.length; i++) { %>       <% var option = options[i] %>       <% if (option.header) { %>  <li data-group="<%= option.group %>" class="am-selected-list-header">       <%= option.text %></li>       <% } else { %>       <li class="<%= option.classNames%>"          data-index="<%= option.index %>"          data-group="<%= option.group || 0 %>"          data-value="<%= option.value %>" >         <span class="am-selected-text"><%= option.text %></span>         <i class="am-icon-check"></i></li>      <% } %>      <% } %>    </ul>    <div class="am-selected-hint"></div>  </div></div>',listTpl:'<% for (var i = 0; i < options.length; i++) { %>       <% var option = options[i] %>       <% if (option.header) { %>  <li data-group="<%= option.group %>" class="am-selected-list-header">       <%= option.text %></li>       <% } else { %>       <li class="<%= option.classNames %>"          data-index="<%= option.index %>"          data-group="<%= option.group || 0 %>"          data-value="<%= option.value %>" >         <span class="am-selected-text"><%= option.text %></span>         <i class="am-icon-check"></i></li>      <% } %>      <% } %>'},Selected.prototype.init=function(){var e=this,t=this.$element,s=this.options;t.hide();var i={id:UI.utils.generateGUID("am-selected"),multiple:this.multiple,options:[],searchBox:s.searchBox,dropUp:s.dropUp,placeholder:s.placeholder};this.$selector=$(UI.template(this.options.tpl,i)),this.$selector.css({width:this.options.btnWidth}),this.$list=this.$selector.find(".am-selected-list"),this.$searchField=this.$selector.find(".am-selected-search input"),this.$hint=this.$selector.find(".am-selected-hint");var l=this.$selector.find(".am-selected-btn"),a=[];s.btnSize&&a.push("am-btn-"+s.btnSize),s.btnStyle&&a.push("am-btn-"+s.btnStyle),l.addClass(a.join(" ")),this.$selector.dropdown({justify:l}),t[0].disabled&&this.disable(),s.maxHeight&&this.$selector.find(".am-selected-list").css({"max-height":s.maxHeight,"overflow-y":"scroll"});var o=[],n=t.attr("minchecked"),d=t.attr("maxchecked")||s.maxChecked;this.maxChecked=d||1/0,t[0].required&&o.push("必选"),(n||d)&&(n&&o.push("至少选择 "+n+" 项"),d&&o.push("至多选择 "+d+" 项")),this.$hint.text(o.join("，")),this.renderOptions(),this.$element.after(this.$selector),this.dropdown=this.$selector.data("amui.dropdown"),this.$status=this.$selector.find(".am-selected-status"),setTimeout(function(){e.syncData(),e.initialized=!0},0),this.bindEvents()},Selected.prototype.renderOptions=function(){function e(e,t,l){if(""===t.value)return!0;var a="";t.disabled&&(a+=s.disabledClass),!t.disabled&&t.selected&&(a+=s.selectedClass),i.push({group:l,index:e,classNames:a,text:t.text,value:t.value})}var t=this.$element,s=this.options,i=[],l=t.find("optgroup");this.$originalOptions=this.$element.find("option"),this.multiple||null!==t.val()||this.$originalOptions.length&&(this.$originalOptions.get(0).selected=!0),l.length?l.each(function(t){i.push({header:!0,group:t+1,text:this.label}),l.eq(t).find("option").each(function(s,i){e(s,i,t)})}):this.$originalOptions.each(function(t,s){e(t,s,null)}),this.$list.html(UI.template(s.listTpl,{options:i})),this.$shadowOptions=this.$list.find("> li").not(".am-selected-list-header")},Selected.prototype.setChecked=function(e){var t=this.options,s=$(e),i=s.hasClass(t.selectedClass);if(this.multiple){var l=this.$list.find("."+t.selectedClass).length;if(!i&&this.maxChecked<=l)return this.$element.trigger("checkedOverflow.selected.amui",{selected:this}),!1}else{if(this.dropdown.close(),i)return!1;this.$shadowOptions.not(s).removeClass(t.selectedClass)}s.toggleClass(t.selectedClass),this.syncData(e)},Selected.prototype.syncData=function(e){var t=this,s=this.options,i=[],l=$([]);if(this.$shadowOptions.filter("."+s.selectedClass).each(function(){var s=$(this);i.push(s.find(".am-selected-text").text()),e||(l=l.add(t.$originalOptions.filter('[value="'+s.data("value")+'"]').prop("selected",!0)))}),e){var a=$(e);this.$originalOptions.filter('[value="'+a.data("value")+'"]').prop("selected",a.hasClass(s.selectedClass))}else this.$originalOptions.not(l).prop("selected",!1);this.$element.val()||(i=[s.placeholder]),this.$status.text(i.join(", ")),this.initialized&&this.$element.trigger("change")},Selected.prototype.bindEvents=function(){var e=this,t="am-selected-list-header",s=UI.utils.debounce(function(s){e.$shadowOptions.not("."+t).hide().filter(':containsNC("'+s.target.value+'")').show()},100);this.$list.on("click","> li",function(s){var i=$(this);!i.hasClass(e.options.disabledClass)&&!i.hasClass(t)&&e.setChecked(this)}),this.$searchField.on("keyup.selected.amui",s),this.$selector.on("closed.dropdown.amui",function(){e.$searchField.val(""),e.$shadowOptions.css({display:""})}),this.$element.on("validated.field.validator.amui",function(t){if(t.validity){var s=t.validity.valid,i="am-invalid";e.$selector[(s?"remove":"add")+"Class"](i)}}),UI.support.mutationobserver&&(this.observer=new UI.support.mutationobserver(function(){e.$element.trigger("changed.selected.amui")}),this.observer.observe(this.$element[0],{childList:!0,subtree:!0,characterData:!0})),this.$element.on("changed.selected.amui",function(){e.renderOptions(),e.syncData()})},Selected.prototype.select=function(e){var t;t="number"==typeof e?this.$list.find("> li").not(".am-selected-list-header").eq(e):"string"==typeof e?this.$list.find(e):$(e),t.trigger("click")},Selected.prototype.enable=function(){this.$element.prop("disable",!1),this.$selector.dropdown("enable")},Selected.prototype.disable=function(){this.$element.prop("disable",!0),this.$selector.dropdown("disable")},Selected.prototype.destroy=function(){this.$element.removeData("amui.selected").show(),this.$selector.remove()},UI.plugin("selected",Selected),UI.ready(function(e){$("[data-am-selected]",e).selected()}),module.exports=Selected;