"use strict";var $=require("jquery"),UI=require("./core"),Validator=function(a,t){this.options=$.extend({},Validator.DEFAULTS,t),this.options.patterns=$.extend({},Validator.patterns,this.options.patterns);var e=this.options.locales;!Validator.validationMessages[e]&&(this.options.locales="zh_CN"),this.$element=$(a),this.init()};Validator.DEFAULTS={debug:!1,locales:"zh_CN",H5validation:!1,H5inputType:["email","url","number"],patterns:{},patternClassPrefix:"js-pattern-",activeClass:"am-active",inValidClass:"am-field-error",validClass:"am-field-valid",validateOnSubmit:!0,alwaysRevalidate:!1,allFields:":input:not(:submit, :button, :disabled, .am-novalidate)",ignore:":hidden:not([data-am-selected], .am-validate)",customEvents:"validate",keyboardFields:":input:not(:submit, :button, :disabled, .am-novalidate)",keyboardEvents:"focusout, change",activeKeyup:!1,textareaMaxlenthKeyup:!0,pointerFields:'input[type="range"]:not(:disabled, .am-novalidate), input[type="radio"]:not(:disabled, .am-novalidate), input[type="checkbox"]:not(:disabled, .am-novalidate), select:not(:disabled, .am-novalidate), option:not(:disabled, .am-novalidate)',pointerEvents:"click",onValid:function(a){},onInValid:function(a){},markValid:function(a){var t=this.options,e=$(a.field),i=e.closest(".am-form-group");e.addClass(t.validClass).removeClass(t.inValidClass),i.addClass("am-form-success").removeClass("am-form-error"),t.onValid.call(this,a)},markInValid:function(a){var t=this.options,e=$(a.field),i=e.closest(".am-form-group");e.addClass(t.inValidClass+" "+t.activeClass).removeClass(t.validClass),i.addClass("am-form-error").removeClass("am-form-success"),t.onInValid.call(this,a)},validate:function(a){},submit:null},Validator.VERSION="{{VERSION}}",Validator.patterns={email:/^((([a-zA-Z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-zA-Z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-zA-Z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-zA-Z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-zA-Z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-zA-Z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-zA-Z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-zA-Z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/,url:/^(https?|ftp):\/\/(((([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-zA-Z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-zA-Z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-zA-Z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-zA-Z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-zA-Z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-zA-Z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-zA-Z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/,number:/^-?(?:\d+|\d{1,3}(?:,\d{3})+)?(?:\.\d+)?$/,dateISO:/^\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}$/,integer:/^-?\d+$/},Validator.validationMessages={zh_CN:{valueMissing:"请填写（选择）此字段",customError:{tooShort:"至少填写 %s 个字符",checkedOverflow:"至多选择 %s 项",checkedUnderflow:"至少选择 %s 项"},patternMismatch:"请按照要求的格式填写",rangeOverflow:"请填写小于等于 %s 的值",rangeUnderflow:"请填写大于等于 %s 的值",stepMismatch:"",tooLong:"至多填写 %s 个字符",typeMismatch:"请按照要求的类型填写"}},Validator.ERROR_MAP={tooShort:"minlength",checkedOverflow:"maxchecked",checkedUnderflow:"minchecked",rangeOverflow:"max",rangeUnderflow:"min",tooLong:"maxlength"},Validator.prototype.init=function(){function a(a){var t=a.toString();return t.substring(1,t.length-1)}function t(a,t,r){var d=t.split(","),n=function(a){e.validate(this)};r&&(n=UI.utils.debounce(n,r)),$.each(d,function(t,e){i.on(e+".validator.amui",a,n)})}var e=this,i=this.$element,r=this.options;return(!r.H5validation||!UI.support.formValidation)&&(i.attr("novalidate","novalidate"),$.each(r.H5inputType,function(t,e){var d=i.find("input[type="+e+"]");d.attr("pattern")||d.is("[class*="+r.patternClassPrefix+"]")||d.attr("pattern",a(r.patterns[e]))}),$.each(r.patterns,function(t,e){var d=i.find("."+r.patternClassPrefix+t);!d.attr("pattern")&&d.attr("pattern",a(e))}),i.on("submit.validator.amui",function(a){if("function"==typeof r.submit)return r.submit.call(e,a);if(r.validateOnSubmit){var t=e.isFormValid();return"boolean"===$.type(t)?t:!!i.data("amui.checked")||($.when(t).then(function(){i.data("amui.checked",!0).submit()},function(){i.data("amui.checked",!1).find("."+r.inValidClass).eq(0).focus()}),!1)}}),t(":input",r.customEvents),t(r.keyboardFields,r.keyboardEvents),t(r.pointerFields,r.pointerEvents),r.textareaMaxlenthKeyup&&t("textarea[maxlength]","keyup",50),void(r.activeKeyup&&t(".am-active","keyup",50)))},Validator.prototype.isValid=function(a){var t=$(a),e=this.options;return(void 0===t.data("validity")||e.alwaysRevalidate)&&this.validate(a),t.data("validity")&&t.data("validity").valid},Validator.prototype.validate=function(a){var t=this,e=this.$element,i=this.options,r=$(a),d=r.data("equalTo");d&&r.attr("pattern","^"+e.find(d).val()+"$");var n=r.attr("pattern")||!1,o=new RegExp(n),l=null,u=null,s=r.is("[type=checkbox]")?(u=e.find('input[name="'+a.name+'"]')).filter(":checked").length:r.is("[type=radio]")?(l=this.$element.find('input[name="'+a.name+'"]')).filter(":checked").length>0:r.val();r=u&&u.length?u.first():r;var F=void 0!==r.attr("required")&&"false"!==r.attr("required"),c=parseInt(r.attr("maxlength"),10),v=parseInt(r.attr("minlength"),10),m=Number(r.attr("min")),f=Number(r.attr("max")),p=this.createValidity({field:r[0],valid:!0});if(i.debug&&window.console&&(console.log("Validate: value -> ["+s+", regex -> ["+o+"], required -> "+F),console.log("Regex test: "+o.test(s)+", Pattern: "+n)),!isNaN(c)&&s.length>c&&(p.valid=!1,p.tooLong=!0),!isNaN(v)&&s.length<v&&(p.valid=!1,p.customError="tooShort"),!isNaN(m)&&Number(s)<m&&(p.valid=!1,p.rangeUnderflow=!0),!isNaN(f)&&Number(s)>f&&(p.valid=!1,p.rangeOverflow=!0),F&&!s)p.valid=!1,p.valueMissing=!0;else if((u||r.is('select[multiple="multiple"]'))&&s){s=u?s:s.length;var h=parseInt(r.attr("minchecked"),10),D=parseInt(r.attr("maxchecked"),10);!isNaN(h)&&s<h&&(p.valid=!1,p.customError="checkedUnderflow"),!isNaN(D)&&s>D&&(p.valid=!1,p.customError="checkedOverflow")}else n&&!o.test(s)&&s&&(p.valid=!1,p.patternMismatch=!0);var g,y=function(a){this.markField(a);var e=$.Event("validated.field.validator.amui");e.validity=a,r.trigger(e).data("validity",a);var i=l||u;return i&&i.not(r).data("validity",a).each(function(){a.field=this,t.markField(a)}),a};if("function"==typeof i.validate&&(g=i.validate.call(this,p)),g){var x=new $.Deferred;return r.data("amui.dfdValidity",x.promise()),$.when(g).always(function(a){x[a.valid?"resolve":"reject"](a),y.call(t,a)})}y.call(this,p)},Validator.prototype.markField=function(a){var t=this.options,e="mark"+(a.valid?"":"In")+"Valid";t[e]&&t[e].call(this,a)},Validator.prototype.validateForm=function(){var a=this,t=this.$element,e=this.options,i=t.find(e.allFields).not(e.ignore),r=[],d=!0,n=[],o=$([]),l=[],u=!1;t.trigger("validate.form.validator.amui");var s=i.filter(function(a){var t;if("INPUT"===this.tagName&&"radio"===this.type){if(t=this.name,r[t]===!0)return!1;r[t]=!0}return!0});s.each(function(){var e=$(this),i=a.isValid(this),r=e.data("validity");d=!!i&&d,n.push(r),i||(o=o.add($(this),t));var s=e.data("amui.dfdValidity");if(s)l.push(s),u=!0;else{var F=new $.Deferred;l.push(F.promise()),F[i?"resolve":"reject"](r)}});var F={valid:d,$invalidFields:o,validity:n,promises:l,async:u};return t.trigger("validated.form.validator.amui",F),F},Validator.prototype.isFormValid=function(){var a=this,t=this.validateForm(),e=function(t){a.$element.trigger(t+".validator.amui")};if(t.async){var i=new $.Deferred;return $.when.apply(null,t.promises).then(function(){i.resolve(),e("valid")},function(){i.reject(),e("invalid")}),i.promise()}if(!t.valid){var r=t.$invalidFields.first();return r.is("[data-am-selected]")&&(r=r.next(".am-selected").find(".am-selected-btn")),r.focus(),e("invalid"),!1}return e("valid"),!0},Validator.prototype.createValidity=function(a){return $.extend({customError:a.customError||!1,patternMismatch:a.patternMismatch||!1,rangeOverflow:a.rangeOverflow||!1,rangeUnderflow:a.rangeUnderflow||!1,stepMismatch:a.stepMismatch||!1,tooLong:a.tooLong||!1,typeMismatch:a.typeMismatch||!1,valid:a.valid||!0,valueMissing:a.valueMissing||!1},a)},Validator.prototype.getValidationMessage=function(a){var t,e,i=Validator.validationMessages[this.options.locales],r="%s",d=$(a.field);return(d.is('[type="checkbox"]')||d.is('[type="radio"]'))&&(d=this.$element.find("[name="+d.attr("name")+"]").first()),$.each(a,function(a,e){return"field"===a||"valid"===a?a:"customError"===a&&e?(t=e,i=i.customError,!1):e===!0?(t=a,!1):void 0}),e=i[t]||void 0,e&&Validator.ERROR_MAP[t]&&(e=e.replace(r,d.attr(Validator.ERROR_MAP[t])||"规定的")),e},Validator.prototype.removeMark=function(){this.$element.find(".am-form-success, .am-form-error, ."+this.options.inValidClass+", ."+this.options.validClass).removeClass(["am-form-success","am-form-error",this.options.inValidClass,this.options.validClass].join(" "))},Validator.prototype.destroy=function(){this.removeMark(),this.$element.removeData("amui.validator amui.checked").off(".validator.amui").find(this.options.allFields).removeData("validity amui.dfdValidity")},UI.plugin("validator",Validator),UI.ready(function(a){$("[data-am-validator]",a).validator()}),module.exports=Validator;